[gd_scene load_steps=12 format=3 uid="uid://cy8kfvob6180f"]

[ext_resource type="Texture2D" uid="uid://bk7scx6n1xs2h" path="res://assets/atomassemblerbackground.png" id="1_ggkhf"]
[ext_resource type="Script" uid="uid://p6ops3lpnto4" path="res://scenes/level1/ParticleSource.gd" id="3_cbrif"]
[ext_resource type="Texture2D" uid="uid://fbgrj4y2yokf" path="res://assets/proton.png" id="4_0wguy"]
[ext_resource type="Texture2D" uid="uid://v4fdbxbl52a7" path="res://assets/neutron.png" id="5_cbrif"]
[ext_resource type="Texture2D" uid="uid://blmx5km62s1jh" path="res://assets/nucleus.jpg" id="6_ke74j"]
[ext_resource type="Texture2D" uid="uid://cw4lukm3b7flj" path="res://assets/electron.png" id="6_l7887"]
[ext_resource type="Script" uid="uid://c5ixkdlesiqg5" path="res://scenes/level1/debug_button.gd" id="7_0wguy"]
[ext_resource type="Script" uid="uid://c1ws6s17i0pnh" path="res://scenes/level1/DropZone.gd" id="7_ke74j"]
[ext_resource type="Texture2D" uid="uid://dmsbxk6xahixy" path="res://assets/outershell.jpg" id="8_hgrql"]
[ext_resource type="Texture2D" uid="uid://d0t3065nokojs" path="res://assets/innershell.jpg" id="9_ufhks"]

[sub_resource type="GDScript" id="GDScript_3k58t"]
script/source = "extends Node2D
# ────────────────────────────────────────────────────────────────
@export var nucleus_radius : float = 64.0
@export var inner_radius   : float = 128.0
@export var outer_radius   : float = 192.0
@export var inner_e_max    : int   = 2
@export var outer_e_max    : int   = 8
# ----------------------------------------------------------------
var ParticleScene : PackedScene = preload(\"res://scenes/level1/DraggableParticle.tscn\")

# counters
var proton_count  : int = 0
var neutron_count : int = 0
var inner_e_count : int = 0
var outer_e_count : int = 0

# the single particle currently being dragged (set by particle script)
var current_dragging : Node = null
# ────────────────────────────────────────────────────────────────
func _ready() -> void:
	_setup_source($ProtonSource,   \"proton\",   preload(\"res://assets/proton.png\"))
	_setup_source($NeutronSource,  \"neutron\",  preload(\"res://assets/neutron.png\"))
	_setup_source($ElectronSource, \"electron\", preload(\"res://assets/electron.png\"))
	_update_counters()
# ----------------------------------------------------------------
func _setup_source(btn: TextureButton, ptype: String, icon: Texture2D) -> void:
	btn.texture_normal = icon
	btn.pressed.connect(Callable(self, \"_on_source_pressed\").bind(ptype, icon))
# ----------------------------------------------------------------
func _on_source_pressed(ptype: String, icon: Texture2D) -> void:
	if current_dragging != null:
		return										# already holding one

	var p := ParticleScene.instantiate()
	p.set(\"type\", ptype)							# dynamic property
	# if the particle scene has a Sprite2D child, give it the icon
	if p.has_node(\"Sprite2D\"):
		p.get_node(\"Sprite2D\").texture = icon
	elif p.has_property(\"texture\"):
		p.texture = icon

	# listen for its “released” custom signal (no static typing)
	if p.has_signal(\"released\"):
		p.connect(\"released\", Callable(self, \"_on_particle_released\"))
	add_child(p)

	current_dragging  = p
	p.global_position = get_global_mouse_position()
	if p.has_method(\"start_drag\"):
		p.call(\"start_drag\")
# ----------------------------------------------------------------
func _on_particle_released(p: Node) -> void:
	if p != current_dragging:
		return

	var ptype : String = p.get(\"type\")
	var zone  : int    = _get_zone(p.global_position, ptype)

	if zone < 0:
		p.queue_free()
	else:
		match zone:
			0: p.global_position = $DropZones/NucleusZone.global_position
			1: p.global_position = $DropZones/InnerShellZone.global_position
			2: p.global_position = $DropZones/OuterShellZone.global_position
		p.set(\"zone\", zone)

		match ptype:
			\"proton\":  if zone == 0: proton_count  += 1
			\"neutron\": if zone == 0: neutron_count += 1
			\"electron\":
				if zone == 1: inner_e_count += 1
				elif zone == 2: outer_e_count += 1
		_update_counters()

	current_dragging = null
	_set_sources_enabled(true)
# ----------------------------------------------------------------
func _set_sources_enabled(enable: bool) -> void:
	$ProtonSource.disabled   = not enable
	$NeutronSource.disabled  = not enable
	$ElectronSource.disabled = not enable
# ----------------------------------------------------------------
func _get_zone(pos: Vector2, ptype: String) -> int:
	var centre : Vector2 = $DropZones/NucleusZone.global_position
	var d      : float   = pos.distance_to(centre)

	if ptype in [\"proton\",\"neutron\"]:
		return 0 if d <= nucleus_radius else -1

	if ptype == \"electron\":
		if d <= nucleus_radius: return -1
		if d <= inner_radius:   return 1
		if inner_e_count >= inner_e_max and d <= outer_radius:
			return 2
	return -1
# ----------------------------------------------------------------
func _update_counters() -> void:
	$ProtonCountLabel.text   = str(proton_count)
	$NeutronCountLabel.text  = str(neutron_count)
	$InnerECountLabel.text   = str(inner_e_count)
	$OuterECountLabel.text   = str(outer_e_count)
# ----------------------------------------------------------------
func _on_back_button_pressed() -> void:
	get_tree().change_scene_to_file(\"res://scenes/level_select.tscn\")
"

[node name="AtomAssembler" type="Node2D"]
script = SubResource("GDScript_3k58t")

[node name="ColorRect" type="ColorRect" parent="."]
offset_right = 1293.0
offset_bottom = 730.0
color = Color(0, 0.368627, 0.658824, 1)
metadata/_edit_use_anchors_ = true

[node name="Sprite2D" type="Sprite2D" parent="."]
position = Vector2(634.439, 291.479)
scale = Vector2(0.53543, 0.528701)
texture = ExtResource("1_ggkhf")
region_enabled = true
region_rect = Rect2(301.051, 0, 928.661, 887.41)

[node name="Sprite2D2" type="Sprite2D" parent="."]
position = Vector2(103.716, 338.618)
scale = Vector2(0.53543, 0.528701)
texture = ExtResource("1_ggkhf")
region_enabled = true
region_rect = Rect2(22.31, 0, 238.207, 827.883)

[node name="VBoxContainer" type="VBoxContainer" parent="."]
offset_left = 10.0
offset_top = 78.0
offset_right = 50.0
offset_bottom = 118.0
scale = Vector2(0.817455, 0.783436)
metadata/_edit_use_anchors_ = true

[node name="ProtonSource" type="TextureButton" parent="."]
offset_left = 72.7162
offset_top = 166.618
offset_right = 253.716
offset_bottom = 351.618
scale = Vector2(0.363646, 0.348512)
texture_normal = ExtResource("4_0wguy")
script = ExtResource("3_cbrif")
icon = ExtResource("4_0wguy")
metadata/_edit_use_anchors_ = true

[node name="NeutronSource" type="TextureButton" parent="."]
offset_left = 75.7162
offset_top = 303.618
offset_right = 256.716
offset_bottom = 503.618
scale = Vector2(0.326273, 0.312695)
texture_normal = ExtResource("5_cbrif")
script = ExtResource("3_cbrif")
icon = ExtResource("5_cbrif")
metadata/_edit_use_anchors_ = true

[node name="ElectronSource" type="TextureButton" parent="."]
offset_left = 72.7162
offset_top = 442.618
offset_right = 253.716
offset_bottom = 627.618
scale = Vector2(0.368308, 0.35298)
texture_normal = ExtResource("6_l7887")
script = ExtResource("3_cbrif")
icon = ExtResource("6_l7887")
metadata/_edit_use_anchors_ = true

[node name="ProtonCountLabel" type="Label" parent="."]
offset_left = 244.0
offset_top = 241.0
offset_right = 352.0
offset_bottom = 264.0
scale = Vector2(0.817455, 0.783436)
text = "Proton Count:"
metadata/_edit_use_anchors_ = true

[node name="NeutronCountLabel" type="Label" parent="."]
offset_left = 242.0
offset_top = 270.0
offset_right = 363.0
offset_bottom = 293.0
scale = Vector2(0.817455, 0.783436)
text = "Neutron Count:"
metadata/_edit_use_anchors_ = true

[node name="InnerECountLabel" type="Label" parent="."]
offset_left = 242.0
offset_top = 292.0
offset_right = 352.0
offset_bottom = 315.0
scale = Vector2(0.817455, 0.783436)
text = "Inner E Count:"
metadata/_edit_use_anchors_ = true

[node name="OuterECountLabel" type="Label" parent="."]
offset_left = 242.0
offset_top = 327.0
offset_right = 356.0
offset_bottom = 350.0
scale = Vector2(0.817455, 0.783436)
text = "Outer E Count:"
metadata/_edit_use_anchors_ = true

[node name="DropZones" type="Node2D" parent="."]
position = Vector2(345, 128)
scale = Vector2(0.686403, 0.649792)

[node name="NucleusZone" type="TextureRect" parent="DropZones"]
offset_left = 863.924
offset_top = -29.2401
offset_right = 1363.92
offset_bottom = 470.76
scale = Vector2(0.452592, 0.484671)
texture = ExtResource("6_ke74j")
script = ExtResource("7_ke74j")

[node name="InnerShellZone" type="TextureRect" parent="DropZones"]
offset_left = 868.295
offset_top = 266.239
offset_right = 1368.29
offset_bottom = 766.239
scale = Vector2(0.4516, 0.4516)
texture = ExtResource("8_hgrql")
script = ExtResource("7_ke74j")

[node name="OuterShellZone" type="TextureRect" parent="DropZones"]
offset_left = 869.751
offset_top = 530.939
offset_right = 1369.75
offset_bottom = 1030.94
scale = Vector2(0.452123, 0.452123)
texture = ExtResource("9_ufhks")
script = ExtResource("7_ke74j")

[node name="DebugButton" type="Button" parent="."]
offset_left = 585.0
offset_top = 35.0
offset_right = 733.0
offset_bottom = 66.0
text = "Enable Next Stage"
script = ExtResource("7_0wguy")

[connection signal="pressed" from="DebugButton" to="DebugButton" method="_on_pressed_molecule_maker"]
